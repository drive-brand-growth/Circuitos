name: Circuit OS RAG - Continuous Integration

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]

jobs:
  health-check:
    name: RAG System Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd Active/metroflex-ghl-website/AI_Agent
          pip install -r requirements.txt

      - name: Validate Python syntax
        run: |
          cd Active/metroflex-ghl-website/AI_Agent
          python -m py_compile rag_core.py
          python -m py_compile rag_adaptive.py
          python -m py_compile adaptive_rag_api.py
          python -m py_compile unified_api_server.py

      - name: Check for common issues
        run: |
          cd Active/metroflex-ghl-website/AI_Agent
          # Check for hardcoded secrets
          ! grep -r "sk-" *.py || (echo "⚠️ Found potential API key in code" && exit 1)
          # Check for TODO/FIXME markers
          grep -r "TODO\|FIXME" *.py || echo "✅ No TODO/FIXME markers found"

  docker-validation:
    name: Docker Configuration Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config > /dev/null
          echo "✅ docker-compose.yml is valid"

      - name: Check Dockerfile syntax
        run: |
          docker build --check Active/metroflex-ghl-website/AI_Agent/Dockerfile Active/metroflex-ghl-website/AI_Agent/ || echo "⚠️ Dockerfile validation requires build context"

      - name: Validate environment variables
        run: |
          # Check required env vars are documented
          grep -q "OPENAI_API_KEY" docker-compose.yml || (echo "❌ Missing OPENAI_API_KEY in docker-compose" && exit 1)
          grep -q "RAG_DATABASE_URL" docker-compose.yml || (echo "❌ Missing RAG_DATABASE_URL in docker-compose" && exit 1)
          echo "✅ Required environment variables are documented"

  cursor-commands-validation:
    name: Cursor Commands Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Cursor commands exist
        run: |
          test -d .cursor/commands/rag || (echo "❌ RAG commands missing" && exit 1)
          test -d .cursor/commands/metroflex || (echo "❌ MetroFlex commands missing" && exit 1)
          test -d .cursor/commands/circuit-os || (echo "❌ Circuit OS commands missing" && exit 1)
          echo "✅ Cursor commands directory structure is valid"

      - name: Validate Markdown syntax
        run: |
          find .cursor/commands -name "*.md" -exec echo "Checking {}" \;
          find .cursor/commands -name "*.md" | wc -l
          echo "markdown files found"

  vscode-tasks-validation:
    name: VS Code Tasks Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tasks.json
        run: |
          test -f .vscode/tasks.json || (echo "❌ tasks.json missing" && exit 1)
          # Validate JSON syntax
          python -m json.tool .vscode/tasks.json > /dev/null
          echo "✅ tasks.json is valid JSON"

      - name: Count tasks
        run: |
          TASK_COUNT=$(python -c "import json; data=json.load(open('.vscode/tasks.json')); print(len(data['tasks']))")
          echo "✅ Found $TASK_COUNT VS Code tasks"
          test "$TASK_COUNT" -gt 15 || (echo "⚠️ Expected at least 15 tasks" && exit 1)

  n8n-workflows-validation:
    name: n8n Workflows Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow JSON
        run: |
          find n8n/workflows -name "*.json" -exec python -m json.tool {} \; > /dev/null
          echo "✅ All n8n workflows are valid JSON"

      - name: Check for RAG workflows
        run: |
          test -f n8n/workflows/rag-nightly-reingestion.json || (echo "❌ Missing nightly workflow" && exit 1)
          test -f n8n/workflows/rag-feedback-reingestion.json || (echo "❌ Missing feedback workflow" && exit 1)
          echo "✅ RAG automation workflows exist"

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [health-check, docker-validation, cursor-commands-validation, vscode-tasks-validation, n8n-workflows-validation]
    if: always()

    steps:
      - name: Report Status
        run: |
          echo "=== Circuit OS RAG CI/CD Status ==="
          echo "Health Check: ${{ needs.health-check.result }}"
          echo "Docker Validation: ${{ needs.docker-validation.result }}"
          echo "Cursor Commands: ${{ needs.cursor-commands-validation.result }}"
          echo "VS Code Tasks: ${{ needs.vscode-tasks-validation.result }}"
          echo "n8n Workflows: ${{ needs.n8n-workflows-validation.result }}"

          if [ "${{ needs.health-check.result }}" == "success" ] && \
             [ "${{ needs.docker-validation.result }}" == "success" ] && \
             [ "${{ needs.cursor-commands-validation.result }}" == "success" ] && \
             [ "${{ needs.vscode-tasks-validation.result }}" == "success" ] && \
             [ "${{ needs.n8n-workflows-validation.result }}" == "success" ]; then
            echo "✅ All checks passed!"
          else
            echo "❌ Some checks failed. Review logs above."
            exit 1
          fi
